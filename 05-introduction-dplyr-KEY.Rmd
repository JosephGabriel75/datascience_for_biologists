---
title: "Data manipulation with `dplyr` KEY"
subtitle: "Data Science for Biologists, Spring 2020"
author: "Stephanie J. Spielmam"
output: 
  html_document:
    highlight: tango
css: static/sjs-style.css
---

<!-- SETUP CODE CHUNK -->
```{r setup, include=FALSE}
## Change the default figure width and height to your liking, but within reason.
knitr::opts_chunk$set(echo = TRUE, fig.width=7, fig.height=3)
library(tidyverse)
library(tidylog) # This must be loaded _AFTER_ tidyverse!
theme_set(theme_classic())
```


## Setup 

We will learn the fundamentals of `dplyr` using the built-in R dataset `CO2`. This dataset is not in the best default format, so we will define it as a tibble for our use, **but save it as a new variable `CO2_tibble`**.

```{r}
# Create a new lowercase variable. __NEVER__ overwrite base R variables. 
# CO2 <- as.tibble(CO2) is _very bad._ Don't do this.
CO2_tibble <- as_tibble(CO2)
head(CO2_tibble)
```

This dataset contains "data from an experiment on the cold tolerance of the grass species _Echinochloa crus-galli_.... The CO2 uptake of six plants from Quebec and six plants from Mississippi was measured at several levels of ambient CO2 concentration. Half the plants of each type were chilled overnight before the experiment was conducted."


### Messages from `tidylog`

To assist in learning `dplyr` (and more packages coming soon), we will also be using the (pre-installed for you) library, `tidylog`. As you can see in the setup R chunk of this document, `tidylog` has been loaded for you. This fairly amazing library provides you with direct feedback about what goes on "under the hood" of `tidyverse` operations.

```{r}
## Obtain all rows where the plant is from Quebec
CO2_tibble %>%
  filter(Type == "Quebec")
```
Because we loaded `tidylog`, we were given this added output information :`## filter: removed 42 rows (50%), 42 rows remaining`. 

## Questions


Perform all exercises using the `%>%` operator. You will probably type it as `>%>` sometimes, so expect this bug ;)

In addition, for any tasks which require multiple steps (a chain of `dplyr` commands), **YOU REALLY REALLY REALLY SHOULD** to do each step one at a time, examine its output, and then proceed to tack on the next step.

##### Question 1
Subset the data using `filter()` to contain only observations from Mississippi (Hint: make sure to spell it right!).

```{r}
CO2_tibble %>%
  filter(Type == "Mississippi")
```

##### Question 2
Subset the data using `filter()` to contain only observations from Mississippi exposed to chilled environment. Hint: You can provide multiple logical statements to `filter()` simply by separating them by commas. This is assumed to mean "and".
```{r}
CO2_tibble %>%
  filter(Type == "Mississippi", Treatment == "chilled")
```

##### Question 3
Subset the data using `filter()` to contain only observations from Mississippi exposed to chilled environment, and _then_ keep only rows `Plant`, `Type`, and `Treatment`.

```{r}
CO2_tibble %>%
  filter(Type == "Mississippi", Treatment == "chilled") %>%
  select(Plant, Type, Treatment)
```

##### Question 4
Remove the columns `uptake` and `conc` from the data using `select()`. In your code, refer only to these two column names - NOT `Plant`, `Type`, etc.
```{r}
CO2_tibble %>%
  select(-uptake, -conc)
```

##### Question 5
Subset the data using `filter()` to contain only observations where the plant is either `Qn1` or `Qn2`. using the `%in%` operator (remember this?) to ask whether `Plant` is _in_ an array of these plants, i.e. `c("Qn1", "Qn2")`
```{r}
CO2_tibble %>%
  filter(Plant %in% c("Qn1", "Qn2"))
```

##### Question 6
Subset the data using `filter()` to contain only rows where uptake is greater than or equal to 38. 
```{r}
CO2_tibble %>%
  filter(uptake >= 38)
```


##### Question 7
Create a _new column_  using `mutate()` called "new_column" where all rows have the value 5. 
```{r}
CO2_tibble %>%
  mutate(new_column = 5)
```


##### Question 8
CO2 concentration in this dataset is measured in mL/L - let's change the units to cL/L (i.e. milli -> centi by dividing by 10). Create a new column using `mutate()` called "conc_cLL" which contains the concentration measured in cL/L.
```{r}
CO2_tibble %>%
  mutate(conc_cLL = conc/10)
```


##### Question 9
Modify your answer to #8 by, at the end, removing the original `conc` column. Save the final result to a new tibble `CO2_tibble2` and examine its output with `head()` to confirm your it all worked.
```{r}
CO2_tibble %>%
  mutate(conc_cLL = conc/10) %>%
  select(-conc) -> CO2_tibble2
head(CO2_tibble2)
```


##### Question 10
Create a new column using `mutate()` called "high_uptake". Rows where uptake is _greater than or equal to 38_ are considered to have high uptakes. Rows with high uptake should be given the value `TRUE`, and `FALSE` otherwise. Hint: Most of the code is identical to your solution to #6!
```{r}
CO2_tibble %>%
  mutate(high_uptake = uptake >= 38)
```

##### Question 11
Calculate the mean uptake (use the function `mean()`) as a new column called "mean_uptake". Do this in two ways: first with `mutate()` and then with `summarize()`. Examine the difference between your outputs to understand the difference between these two `dplyr` verbs.
```{r}
CO2_tibble %>%
  mutate(mean_uptake = mean(uptake))

CO2_tibble %>%
  summarize(mean_uptake = mean(uptake))
```

##### Question 12
Create a new tibble called "quebec" that contains _only_ plants from Quebec. Work with this tibble to determine the following:
```{r}
quebec <- filter(CO2_tibble, Type == "Quebec")
```
+ What is the mean (function `mean()`) uptake for Quebec plants? **Use `summarize()`**, no dollar signs!
  ```{r}
  quebec %>%
    summarize(mean(uptake))
  ```
+ What is the mean uptake for all _chilled_ Quebec plants? Again use `summarize()`, but first you'll want to filter the data for only chilled plants. 
  ```{r}
  quebec %>%
    filter(Treatment == "chilled") %>%
    summarize(mean(uptake))
  ```
+ Without filtering, use a single chain of commands to determine the mean uptake for both chilled and nonchilled Quebec plants. You'll need to use `group_by()` to setup `summarize()` to do calculations separately for these two groups.
  ```{r}
  quebec %>%
    group_by(Treatment) %>%
    summarize(mean(uptake))
  ```
+ What is the median (function `median()`) uptake for Quebec plants?
  ```{r}
  quebec %>%
    summarize(median(uptake))
  ```
+ What is the median uptake for Quebec plants exposed to a concentration of 500 mL/L? Again, filter before summarizing (and remember `==`!!).
  ```{r}
  quebec %>%
    filter(conc == 500) %>%
    summarize(median(uptake))
  ```
+ What is the median update for chilled and nonchilled Quebec plants separately exposed to a concentration of 500 mL/L? Hint: this takes _three steps_.
  ```{r}
  quebec %>%
    filter(conc == 500) %>%
    group_by(Treatment) %>%
    summarize(median(uptake))
  ```
+ How many plants have an uptake less than 25 when exposed to a CO2 concentration of 500 mL/L? You can answer this by piping your commands into `tally()` but without grouping the data - `dplyr` will assume all data is one group, and simply count the the number of rows!
  ```{r}
  quebec %>%
    filter(conc == 500, uptake < 25) %>%
    tally()
  ```
##### Question 13
Let's now compare plants from Mississippi to those from Quebec in _one chain of commands_: Which plant type has a higher mean uptake, considering only nonchilled plants exposed to a concentration of 1000 mL/L? 
  ```{r}
  CO2_tibble %>%
    filter(conc == 1000, Treatment == "nonchilled") %>%
    group_by(Type) %>%
    summarize(mean(uptake))
  ```


##### Question 14
Now seems as good a time as any to introduce line plots! Together, we will learn how to create the plot shown below. We will also discuss whether the points as shown are a good idea or not.


```{r, echo=FALSE}
ggplot(CO2_tibble, aes(x = conc, y = uptake, group = Plant, color = Treatment)) + 
  geom_line() + 
  geom_point() +
  facet_grid(~Type) + 
  labs(x = "Concentration", y = "Uptake")
```



